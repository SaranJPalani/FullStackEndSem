<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Amma's Healing</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/chatbot.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>Amma's Healing</h1>
            </div>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/cart">Cart <span id="cart-count" class="badge">0</span></a>
                <a href="/orders" id="orders-link">Orders</a>
                <a href="/profile" id="profile-link">Profile</a>
                <a href="/admin" id="admin-link" style="display: none;">Admin</a>
                <button id="auth-btn" class="btn btn-primary">Logout</button>
            </div>
        </div>
    </nav>

    <section class="profile-section">
        <div class="container">
            <h1>My Profile</h1>
            
            <div class="profile-container">
                <!-- Profile Info Display -->
                <div id="profile-display" class="profile-card">
                    <h2>Profile Information</h2>
                    <div class="profile-info">
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span id="display-name" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span id="display-email" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span id="display-phone" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Role:</span>
                            <span id="display-role" class="info-value badge"></span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="showEditForm()">Edit Profile</button>
                </div>

                <!-- Address Display -->
                <div id="address-display" class="profile-card">
                    <h2>Address Information</h2>
                    <div class="profile-info">
                        <div class="info-row">
                            <span class="info-label">Street:</span>
                            <span id="display-street" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">City:</span>
                            <span id="display-city" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">State:</span>
                            <span id="display-state" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Pincode:</span>
                            <span id="display-pincode" class="info-value"></span>
                        </div>
                    </div>
                </div>

                <!-- Edit Profile Form -->
                <div id="edit-form" class="profile-card" style="display: none;">
                    <h2>Edit Profile</h2>
                    <form id="profile-form">
                        <div class="form-group">
                            <label for="edit-name">Name *</label>
                            <input type="text" id="edit-name" required>
                        </div>

                        <div class="form-group">
                            <label for="edit-email">Email *</label>
                            <input type="email" id="edit-email" required disabled>
                            <small>Email cannot be changed</small>
                        </div>

                        <div class="form-group">
                            <label for="edit-phone">Phone *</label>
                            <input type="tel" id="edit-phone" required>
                        </div>

                        <h3 style="margin-top: 20px;">Address</h3>

                        <div class="form-group">
                            <label for="edit-street">Street *</label>
                            <input type="text" id="edit-street" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-city">City *</label>
                                <input type="text" id="edit-city" required>
                            </div>

                            <div class="form-group">
                                <label for="edit-state">State</label>
                                <input type="text" id="edit-state">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="edit-pincode">Pincode *</label>
                            <input type="text" id="edit-pincode" required>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <script>
        const API_URL = 'http://localhost:5000/api';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // Check authentication
        if (!token) {
            window.location.href = '/login';
        }

        // Setup auth button
        document.getElementById('auth-btn').onclick = () => {
            localStorage.clear();
            window.location.href = '/';
        };

        if (user.role === 'admin') {
            document.getElementById('admin-link').style.display = 'inline';
        }

        // Load profile
        async function loadProfile() {
            try {
                const response = await fetch(`${API_URL}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    displayProfile(data.data);
                } else {
                    alert('Failed to load profile');
                }
            } catch (error) {
                alert('Error loading profile');
            }
        }

        function displayProfile(profile) {
            document.getElementById('display-name').textContent = profile.name;
            document.getElementById('display-email').textContent = profile.email;
            document.getElementById('display-phone').textContent = profile.phone;
            document.getElementById('display-role').textContent = profile.role;
            document.getElementById('display-role').className = `badge ${profile.role === 'admin' ? 'badge-admin' : 'badge-customer'}`;

            if (profile.address) {
                document.getElementById('display-street').textContent = profile.address.street || 'Not set';
                document.getElementById('display-city').textContent = profile.address.city || 'Not set';
                document.getElementById('display-state').textContent = profile.address.state || 'Not set';
                document.getElementById('display-pincode').textContent = profile.address.pincode || 'Not set';
            }

            // Populate edit form
            document.getElementById('edit-name').value = profile.name;
            document.getElementById('edit-email').value = profile.email;
            document.getElementById('edit-phone').value = profile.phone;
            
            if (profile.address) {
                document.getElementById('edit-street').value = profile.address.street || '';
                document.getElementById('edit-city').value = profile.address.city || '';
                document.getElementById('edit-state').value = profile.address.state || '';
                document.getElementById('edit-pincode').value = profile.address.pincode || '';
            }
        }

        function showEditForm() {
            document.getElementById('profile-display').style.display = 'none';
            document.getElementById('address-display').style.display = 'none';
            document.getElementById('edit-form').style.display = 'block';
        }

        function cancelEdit() {
            document.getElementById('profile-display').style.display = 'block';
            document.getElementById('address-display').style.display = 'block';
            document.getElementById('edit-form').style.display = 'none';
        }

        // Update profile
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const updatedProfile = {
                name: document.getElementById('edit-name').value,
                phone: document.getElementById('edit-phone').value,
                address: {
                    street: document.getElementById('edit-street').value,
                    city: document.getElementById('edit-city').value,
                    state: document.getElementById('edit-state').value,
                    pincode: document.getElementById('edit-pincode').value
                }
            };

            try {
                const response = await fetch(`${API_URL}/auth/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updatedProfile)
                });

                const data = await response.json();

                if (data.success) {
                    // Update localStorage
                    const updatedUser = { ...user, ...data.data };
                    localStorage.setItem('user', JSON.stringify(updatedUser));

                    alert('Profile updated successfully!');
                    displayProfile(data.data);
                    cancelEdit();
                } else {
                    alert(data.message || 'Failed to update profile');
                }
            } catch (error) {
                alert('Error updating profile');
            }
        });

        // Initialize
        loadProfile();
    </script>

    <style>
        .profile-section {
            padding: 40px 0;
            min-height: calc(100vh - 80px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .profile-section h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .profile-card h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .profile-info {
            margin: 20px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: bold;
            color: #666;
        }

        .info-value {
            color: #333;
        }

        .badge-admin {
            background-color: #dc3545;
        }

        .badge-customer {
            background-color: #28a745;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-actions button {
            flex: 1;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="/js/chatbot.js"></script>
</body>
</html>
